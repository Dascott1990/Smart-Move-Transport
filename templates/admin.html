{% extends "base.html" %}

{% block title %}Admin ‚Ä¢ Capitol City Contracting{% endblock %}

{% block extra_css %}
<!-- Apple-like modern UI CSS (responsive + accessible) -->
<style>
:root{
  --bg: #f5f7fa;
  --panel: rgba(255,255,255,0.85);
  --muted: #6b7280;
  --accent: #0b3d91;
  --success: #0f6b44;
  --warning: #d6a33a;
  --danger: #dc3545;
  --glass: rgba(255,255,255,0.6);
  --radius: 14px;
  --shadow-sm: 0 6px 18px rgba(15,23,42,0.06);
  --shadow-lg: 0 20px 40px rgba(15,23,42,0.08);
  --max-width: 1200px;
  font-synthesis: none;
}

/* Base */
body {
  background: linear-gradient(180deg, var(--bg) 0%, #eef2f6 100%);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color: #0f172a;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  margin: 0;
}

/* Container grid */
.admin-shell {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 28px;
  max-width: calc(var(--max-width) + 320px);
  margin: 28px auto;
  padding: 20px;
}

/* Sidebar (left) */
.sidebar {
  position: sticky;
  top: 28px;
  height: calc(100vh - 56px);
  border-radius: var(--radius);
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.7));
  box-shadow: var(--shadow-sm);
  padding: 20px;
  border: 1px solid rgba(11,61,145,0.06);
  display:flex;
  flex-direction:column;
  gap: 16px;
}

/* Logo area */
.sidebar .brand {
  display:flex;
  align-items:center;
  gap:12px;
}
.sidebar .brand img { height:34px; width:auto; border-radius:8px; }
.sidebar .brand .title { font-weight:700; letter-spacing:0.2px; color:var(--accent); font-size:15px; }
.sidebar .brand .sub { font-size:12px; color:var(--muted); }

/* Nav */
.nav {
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:6px;
  flex:1;
}
.nav a {
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 12px;
  border-radius:10px;
  text-decoration:none;
  color: #071133;
  font-weight:600;
  font-size:14px;
}
.nav a .icon { font-size:18px; opacity:0.9; }
.nav a.active {
  background: linear-gradient(90deg, rgba(11,61,145,0.06), rgba(11,61,145,0.03));
  box-shadow: 0 8px 20px rgba(11,61,145,0.04) inset;
  color: var(--accent);
}

/* Main area */
.main {
  padding: 12px;
  margin-top: 8px;
}

/* Top bar inside main */
.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:18px;
}
.topbar .title {
  display:flex;
  flex-direction:column;
}
.h1 {
  font-size:20px;
  font-weight:700;
  color:#071133;
  margin:0;
}
.h1-sub {
  color:var(--muted); font-size:13px; margin-top:6px;
}

/* Controls */
.controls {
  display:flex;
  gap:10px;
  align-items:center;
}
.btn {
  --pad-y:8px;
  --pad-x:12px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: var(--pad-y) var(--pad-x);
  border-radius:10px;
  border:1px solid rgba(11,61,145,0.06);
  background: white;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  box-shadow: var(--shadow-sm);
}
.btn.primary {
  background: linear-gradient(180deg, #0b4bbe, #083e9a);
  color: white;
  border: none;
}
.btn.ghost { background: transparent; border:1px solid rgba(11,61,145,0.06); }

/* Statistics grid */
.stats-grid {
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:14px;
  margin-bottom:18px;
}
.stat {
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.7));
  border-radius:12px;
  padding:16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(11,61,145,0.04);
}
.stat .num { font-weight:800; font-size:22px; color:var(--accent); }
.stat .label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-top:6px; }

/* Table card */
.card {
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.7));
  border-radius:14px;
  padding:12px;
  box-shadow: var(--shadow-sm);
  border:1px solid rgba(11,61,145,0.04);
}

/* Search + filters row */
.toolbar {
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
  margin-bottom:10px;
}
.toolbar-left { display:flex; gap:8px; align-items:center; }
.input, .select {
  padding:8px 10px;
  border-radius:9px;
  border:1px solid rgba(11,61,145,0.06);
  background:white;
  font-size:13px;
}

/* Table styles */
.table {
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
.table thead th {
  text-align:left;
  font-size:12px;
  color:var(--muted);
  padding:12px 10px;
  border-bottom:1px solid rgba(11,61,145,0.04);
}
.table tbody td {
  padding:14px 10px;
  vertical-align:middle;
  border-bottom:1px dashed rgba(11,61,145,0.03);
}

/* avatar */
.avatar {
  width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; font-weight:700;
  background: linear-gradient(135deg, rgba(11,61,145,0.85), rgba(11,61,145,0.55));
  color:white; font-size:14px;
}

/* status badge */
.badge {
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:12px;
}
.badge.pending { background: rgba(214,163,58,0.12); color: var(--warning); border: 1px solid rgba(214,163,58,0.08); }
.badge.confirmed { background: rgba(15,107,68,0.08); color: var(--success); border: 1px solid rgba(15,107,68,0.06); }
.badge.completed { background: rgba(11,61,145,0.08); color: var(--accent); border: 1px solid rgba(11,61,145,0.06); }
.badge.cancelled { background: rgba(220,53,69,0.08); color: var(--danger); border: 1px solid rgba(220,53,69,0.06); }

/* action group */
.actions { display:flex; gap:8px; align-items:center; }

/* responsive: collapse into single-column for small screens */
@media (max-width: 1000px) {
  .admin-shell { grid-template-columns: 72px 1fr; gap:18px; max-width: 980px; }
  .sidebar { padding:12px; border-radius:12px; }
  .nav a { padding:8px; font-size:12px; justify-content:center; }
  .nav a span.label { display:none; }
  .brand .title, .brand .sub { display:none; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 720px) {
  .admin-shell { grid-template-columns: 1fr; padding:12px; }
  .sidebar { position:relative; height:auto; order:2; display:flex; flex-direction:row; gap:10px; overflow:auto; }
  .main { order:1; }
  .stats-grid { grid-template-columns: 1fr; }
  .table thead { display:none; }
  .table tbody td { display:block; padding:10px 0; border-bottom:1px solid rgba(11,61,145,0.04); }
  .table tbody tr { margin-bottom:12px; display:block; background:transparent; padding:10px 0; }
  .toolbar { flex-direction:column; align-items:stretch; gap:8px; }
}

/* subtle focus styles for accessibility */
a:focus, button:focus, .input:focus, .select:focus {
  outline: 3px solid rgba(11,61,145,0.12);
  outline-offset: 3px;
}

/* small helpers */
.text-muted { color: var(--muted); font-size:13px; }
.small { font-size:12px; color:var(--muted); }
</style>
{% endblock %}

{% block content %}
<div class="admin-shell" role="application" aria-label="Admin dashboard">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" aria-label="Primary">
    <div class="brand" aria-hidden="false">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Capitol City logo">
      <div>
        <div class="title">Capitol City</div>
        <div class="sub">Admin Dashboard</div>
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="Main navigation">
      <a href="#bookings" class="active" id="nav-bookings"><span class="icon">üìÖ</span><span class="label">Bookings <span class="small" style="margin-left:6px; color:var(--muted)">{{ bookings|length }}</span></span></a>
      <a href="#analytics" id="nav-analytics"><span class="icon">üìà</span><span class="label">Analytics</span></a>
      <a href="#services" id="nav-services"><span class="icon">üõ†Ô∏è</span><span class="label">Services</span></a>
      <a href="#testimonials" id="nav-testimonials"><span class="icon">üí¨</span><span class="label">Testimonials</span></a>
      <a href="{{ url_for('index') }}" class="text-danger" id="nav-back"><span class="icon">‚Ü©Ô∏è</span><span class="label">Back to Site</span></a>
    </nav>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <button id="sidebarToggle" aria-expanded="true" class="btn ghost" title="Toggle sidebar">Toggle</button>
      <button id="logoutBtn" class="btn" onclick="location.href='{{ url_for('index') }}'">View site</button>
    </div>
  </aside>

  <!-- Main area -->
  <main class="main" id="main" tabindex="-1">
    <div class="topbar">
      <div class="title">
        <div class="h1">Booking Management</div>
        <div class="h1-sub">Manage and track customer booking requests</div>
      </div>

      <div class="controls" role="region" aria-label="Quick controls">
        <button class="btn ghost" onclick="refreshBookings()" title="Refresh">‚ü≥ Refresh</button>
        <button class="btn primary" onclick="exportBookings()" title="Export bookings">‚¨áÔ∏é Export</button>
      </div>
    </div>

    <!-- Stats -->
    <section class="stats-grid" aria-label="Statistics overview">
      <div class="stat" aria-hidden="false">
        <div class="num">{{ bookings|length }}</div>
        <div class="label">Total Bookings</div>
        <div class="small">12% from last month ‚Ä¢ <span class="text-muted">updated</span></div>
      </div>
      <div class="stat">
        <div class="num">{{ bookings|selectattr('status', 'equalto', 'pending')|list|length }}</div>
        <div class="label">Pending</div>
        <div class="small">Needs attention</div>
      </div>
      <div class="stat">
        <div class="num">{{ bookings|selectattr('status', 'equalto', 'confirmed')|list|length }}</div>
        <div class="label">Confirmed</div>
        <div class="small">Scheduled</div>
      </div>
      <div class="stat">
        <div class="num">{{ bookings|selectattr('status', 'equalto', 'completed')|list|length }}</div>
        <div class="label">Completed</div>
        <div class="small">Finished projects</div>
      </div>
    </section>

    <!-- Table card -->
    <section class="card" aria-labelledby="all-bookings-heading">
      <div class="toolbar">
        <div class="toolbar-left">
          <label for="statusFilter" class="small" style="margin-right:6px;">Filter</label>
          <select id="statusFilter" class="select" onchange="filterByStatus(this.value)">
            <option value="">All status</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <input id="searchInput" onkeyup="searchBookings(this.value)" class="input" placeholder="Search bookings..." aria-label="Search bookings">
        </div>

        <div class="small text-muted">Showing <strong>{{ bookings|length }}</strong> bookings</div>
      </div>

      <div style="overflow:auto;">
        <table class="table" role="table" aria-describedby="all-bookings-heading">
          <thead>
            <tr>
              <th scope="col">Customer</th>
              <th scope="col">Service</th>
              <th scope="col">Date & Time</th>
              <th scope="col">Contact</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>

          <tbody id="bookingsBody">
            {% for booking in bookings %}
            <tr class="booking-row" data-booking-id="{{ booking.id }}" data-status="{{ booking.status }}">
              <td>
                <div style="display:flex; gap:12px; align-items:center;">
                  <div class="avatar" aria-hidden="true">{{ booking.customer_name[0]|upper }}</div>
                  <div>
                    <div style="font-weight:700;">{{ booking.customer_name }}</div>
                    <div class="small text-muted">#{{ booking.id }}</div>
                  </div>
                </div>
              </td>

              <td>
                <div style="font-weight:700;">{{ booking.service.name }}</div>
                <div class="small text-muted">{{ booking.project_description[:60] }}{% if booking.project_description|length > 60 %}...{% endif %}</div>
              </td>

              <td>
                <div style="font-weight:700;">{{ booking.preferred_date }}</div>
                <div class="small text-muted">{{ booking.preferred_time }}</div>
              </td>

              <td>
                <div style="font-weight:700;">{{ booking.customer_phone }}</div>
                <div class="small text-muted">{{ booking.customer_email }}</div>
              </td>

              <td>
                <span class="badge status-{{ booking.status }} {{ booking.status }}">{{ booking.status|title }}</span>
              </td>

              <td>
                <div class="actions">
                  <button class="btn" title="View details" onclick="viewBookingDetails({{ booking.id }})">üëÅÔ∏é</button>

                  <select class="select status-select" data-booking-id="{{ booking.id }}" onchange="onStatusChange(event)">
                    <option value="pending" {% if booking.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="confirmed" {% if booking.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="completed" {% if booking.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if booking.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  </select>

                  <button class="btn" title="Delete" onclick="deleteBooking({{ booking.id }})">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" style="text-align:center; padding:48px 12px;">
                <div style="font-size:48px; color:rgba(11,61,145,0.08)">üì≠</div>
                <div style="font-weight:700; margin-top:8px;">No bookings found</div>
                <div class="small text-muted">When customers make bookings they‚Äôll appear here.</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Quick Actions -->
    <section style="margin-top:14px;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div>
            <div style="font-weight:700;">Quick Actions</div>
            <div class="small text-muted">Common admin tasks</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" onclick="sendBulkNotifications()">üîî Notify Pending</button>
            <button class="btn" onclick="exportPendingBookings()">‚¨áÔ∏é Export Pending</button>
            <button class="btn ghost" onclick="markAllPendingAsConfirmed()">‚úîÔ∏é Confirm All Pending</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Booking details modal placeholder (will be inserted dynamically) -->
<div id="modal-root" aria-live="polite"></div>
{% endblock %}

{% block extra_js %}
<script>
/* Responsive behavior, status updates, and helpers.
   Designed to work with your Flask endpoints already in place.
*/

/* Sidebar toggle for narrow screens */
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
if (sidebarToggle) {
  sidebarToggle.addEventListener('click', () => {
    const expanded = sidebar.getAttribute('data-collapse') === 'true';
    sidebar.setAttribute('data-collapse', !expanded);
    sidebar.style.display = (expanded ? 'flex' : 'none');
  });
}

/* Utility: show transient notification */
function showNotification(message, type = 'info') {
  const container = document.createElement('div');
  container.className = 'notification';
  container.style.cssText = 'position:fixed; right:20px; top:24px; z-index:2000; min-width:260px;';
  container.innerHTML = `<div style="background: white; padding:12px 14px; border-radius:10px; box-shadow: 0 12px 30px rgba(2,6,23,0.08); border:1px solid rgba(11,61,145,0.04); font-weight:700;">
      ${message}
    </div>`;
  document.body.appendChild(container);
  setTimeout(()=> container.remove(), 4500);
}

/* Status update: called by select change handler */
function updateBookingStatus(bookingId, newStatus) {
  fetch(`/api/admin/bookings/${bookingId}/status`, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({status: newStatus})
  })
  .then(r => r.json())
  .then(res => {
    if (res.message) {
      // update the badge visually
      const row = document.querySelector(`[data-booking-id="${bookingId}"]`);
      if (row) {
        const badge = row.querySelector('.badge');
        badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
        // normalize class list
        ['pending','confirmed','completed','cancelled'].forEach(c => badge.classList.remove(c));
        badge.classList.add(newStatus);
        showNotification('Status updated', 'success');
      }
      // optional: refresh stats - simplest way: reload counts client-side
      setTimeout(refreshStats, 300);
    } else {
      showNotification('Failed to update status', 'error');
    }
  })
  .catch(e => {
    console.error(e);
    showNotification('Network error while updating status', 'error');
  });
}

/* Handler wired in template */
function onStatusChange(event) {
  const select = event.target;
  const bookingId = select.dataset.bookingId;
  const newStatus = select.value;
  updateBookingStatus(bookingId, newStatus);
}

/* View booking details modal (lightweight) */
function viewBookingDetails(bookingId) {
  // gather row data
  const row = document.querySelector(`[data-booking-id="${bookingId}"]`);
  if (!row) return;
  const customer = row.querySelector('td:nth-child(1) div:nth-child(2)')?.innerText || '';
  const service = row.querySelector('td:nth-child(2) div')?.innerText || '';
  const date = row.querySelector('td:nth-child(3) div')?.innerText || '';
  const phone = row.querySelector('td:nth-child(4) div')?.innerText || '';
  const email = row.querySelector('td:nth-child(4) .small')?.innerText || '';

  const modal = document.createElement('div');
  modal.setAttribute('role','dialog');
  modal.setAttribute('aria-modal','true');
  modal.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:3000;';
  modal.innerHTML = `
    <div style="width:94%; max-width:720px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); border-radius:14px; padding:18px; box-shadow:0 24px 60px rgba(2,6,23,0.16); border:1px solid rgba(11,61,145,0.04);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <div style="font-weight:800; font-size:16px;">Booking #${bookingId}</div>
          <div class="small text-muted">Details</div>
        </div>
        <div>
          <button class="btn" id="closeModal">Close</button>
        </div>
      </div>
      <hr style="border:none; border-top:1px solid rgba(11,61,145,0.04); margin:12px 0;">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <div style="font-weight:700;">Customer</div>
          <div style="margin-top:6px;">${customer}</div>
          <div class="small text-muted" style="margin-top:6px;">Phone: ${phone}<br>Email: ${email}</div>
        </div>
        <div>
          <div style="font-weight:700;">Service & Schedule</div>
          <div style="margin-top:6px;">${service}</div>
          <div class="small text-muted" style="margin-top:6px;">${date}</div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // close handler
  const closeBtn = document.getElementById('closeModal');
  closeBtn.addEventListener('click', () => modal.remove());
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

/* Delete booking (client-side placeholder) */
function deleteBooking(bookingId) {
  if (!confirm('Delete this booking? This cannot be undone.')) return;
  // If you implement a DELETE endpoint, call it here; for now remove from DOM
  const row = document.querySelector(`[data-booking-id="${bookingId}"]`);
  if (row) {
    row.remove();
    showNotification('Booking removed (UI only)', 'warning');
    setTimeout(refreshStats, 200);
  }
}

/* Simple search and filter (client-side) */
function filterByStatus(status) {
  const rows = document.querySelectorAll('.booking-row');
  rows.forEach(row => {
    row.style.display = (!status || row.dataset.status === status) ? '' : 'none';
  });
}

function searchBookings(query) {
  const q = query.trim().toLowerCase();
  const rows = document.querySelectorAll('.booking-row');
  rows.forEach(row => {
    if (!q) { row.style.display = ''; return; }
    const txt = row.innerText.toLowerCase();
    row.style.display = txt.includes(q) ? '' : 'none';
  });
}

/* small helper: re-calc stats from DOM (client-side refreshStats) */
function refreshStats() {
  try {
    const rows = document.querySelectorAll('.booking-row');
    const total = rows.length;
    const pending = Array.from(rows).filter(r => r.dataset.status === 'pending' && r.style.display !== 'none').length;
    const confirmed = Array.from(rows).filter(r => r.dataset.status === 'confirmed' && r.style.display !== 'none').length;
    const completed = Array.from(rows).filter(r => r.dataset.status === 'completed' && r.style.display !== 'none').length;

    const statEls = document.querySelectorAll('.stat .num');
    if (statEls.length >= 4) {
      statEls[0].textContent = total;
      statEls[1].textContent = pending;
      statEls[2].textContent = confirmed;
      statEls[3].textContent = completed;
    }
  } catch(e){ console.warn(e); }
}

/* Placeholder actions */
function refreshBookings() { location.reload(); }
function exportBookings() { showNotification('Export would be triggered (server-side).', 'info'); }
function sendBulkNotifications() { showNotification('Bulk notifications would be queued (server-side).', 'info'); }
function exportPendingBookings() { showNotification('Export pending bookings (server-side).', 'info'); }
function markAllPendingAsConfirmed() {
  if (!confirm('Confirm all pending bookings?')) return;
  // naive implementation: change selects on page and send updates sequentially
  const selects = document.querySelectorAll('.status-select');
  const pendingSelects = Array.from(selects).filter(s => s.value === 'pending');
  pendingSelects.forEach(s => {
    s.value = 'confirmed';
    const id = s.dataset.bookingId;
    updateBookingStatus(id, 'confirmed');
  });
}

/* Attach status select listeners (for server-proxy compatibility) */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.status-select').forEach(sel => {
    sel.addEventListener('change', onStatusChange);
  });
});
</script>
{% endblock %}
